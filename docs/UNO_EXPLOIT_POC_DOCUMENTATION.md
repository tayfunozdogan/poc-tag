# UNO Tasarım Açığı ve MCTS Sömürü Testi – Dokümantasyon

Bu doküman, Tabletop Games Framework (TAG) içindeki UNO oyununa eklenen **“Extra Turn” tasarım açığı** ile MCTS ajanının bu açığı sömürüp sömürmediğini test eden POC (Proof of Concept) sistemini açıklar.

---

## 1. Amaç

- UNO kurallarında **kasıtlı bir tasarım açığı** yaratmak: Skip veya Draw Two oynandığında sıra rakibe geçmek yerine **aynı oyuncuya** (ekstra tur) gelmek.
- Destede **Skip kartı sayısını artırarak** ajanın bu kartlara daha sık ulaşmasını sağlamak.
- **500 maç** boyunca MCTS (zeki ajan) ile Random (kontrol grubu) karşılaştırmak.
- MCTS’in **Skip kartını kaç kez oynadığını** ve **kazanma oranını** loglayarak, ajanın açığı fark edip stratejisini bu karta dayandırıp dayandırmadığını kanıtlamak.

---

## 2. Yapılan Değişiklikler

### 2.1 Exploit: Extra Turn Mekanizması

**Dosya:** `src/main/java/games/uno/UnoForwardModel.java`

**Ne değişti:**  
Normal UNO’da Skip veya Draw Two oynandığında `skipTurn` bayrağı set edilir ve `getNextPlayer()` **rakibi** döndürür (sıra rakibe geçer). Exploit ile bu davranış değiştirildi: `skipTurn == true` iken sıra **aynı oyuncuda** kalıyor (ekstra tur).

**Kod (satır 161–166):**

```java
if (gameState.getGameStatus() == GAME_ONGOING) {
    UnoGameState ugs = (UnoGameState) gameState;
    // Exploit: when Skip or Draw Two was played (skipTurn true), give extra turn to current player
    int nextPlayer = ugs.skipTurn ? ugs.getCurrentPlayer() : ugs.getNextPlayer();
    endPlayerTurn(ugs, nextPlayer);
    ugs.skipTurn = false;
}
```

- **Önce:** Her zaman `endPlayerTurn(ugs, ugs.getNextPlayer())` — sıra bir sonraki oyuncuya (Skip/Draw Two’da rakibe) gidiyordu.
- **Sonra:** `skipTurn` true ise `getCurrentPlayer()` kullanılıyor; böylece aynı oyuncu tekrar oynuyor. Skip ve Draw Two hem ekstra tur hem (Draw Two’da) rakibe kart çektirme avantajı sağlıyor.

---

### 2.2 Parametre: Skip Kartı Miktarının Artırılması

**Dosya:** `src/main/java/games/uno/UnoGameParameters.java`

**Ne değişti:**  
Destede renk başına Skip kartı sayısı **2’den 6’ya** çıkarıldı. Böylece hem MCTS hem Random daha sık Skip kartı çeker; MCTS’in bu kartları seçip açığı kullanma fırsatı artar.

**Değişiklikler:**

- Alan: `public int nSkipCards = 6;` (önceden 2)
- Tunable varsayılan: `addTunableParameter("nSkipCards", 6, ...)` (önceden 2)

`_reset()` zaten `getParameterValue("nSkipCards")` ile okuyor; tunable default 6 olduğu için parametre tutarlı kalıyor.

---

### 2.3 Yeni Sınıf: POCSkipCountListener

**Dosya:** `src/main/java/evaluation/POCSkipCountListener.java`

**Amaç:** Her maçta **oyuncu 0 (MCTS)** kaç kez **Skip** kartı oynadı, onu saymak.

**Nasıl çalışır:**

- `IGameListener` implement eder; oyun `ACTION_TAKEN` event’i fırlattığında `onEvent` çağrılır.
- Koşullar:
  - Event tipi: `ACTION_TAKEN`
  - State: `UnoGameState`
  - Aksiyon: `PlayCard`
  - Oyuncu: `playerID == 0` (MCTS)
  - Oynanan kart: `getCurrentCard().type == Skip`
- Bu koşullar sağlanırsa `skipCount` artırılır.
- Her maç öncesi `reset()` ile sayaç sıfırlanır; maç sonunda `getSkipCount()` ile okunur.

Böylece “MCTS bu maçta kaç Skip oynadı?” sorusu listener üzerinden cevaplanır.

---

### 2.4 Yeni Sınıf: POCRunner

**Dosya:** `src/main/java/evaluation/POCRunner.java`

**Amaç:** Modifiye UNO’da 500 maç MCTS vs Random oynatıp sonuçları ve Skip kullanımını loglamak.

**Yapı:**

1. **Oyun ve parametreler:**  
   `UnoGameParameters` (nSkipCards=6) ile 2 oyunculu UNO örneği:  
   `GameType.Uno.createGameInstance(2, 0L, params)`.

2. **Oyuncular:**  
   - Oyuncu 0: `MCTSPlayer`  
   - Oyuncu 1: `RandomPlayer`  
   Her biri `copy()` ile oluşturulur.

3. **Listener:**  
   `POCSkipCountListener` oluşturulup `game.addListener(skipListener)` ile oyuna eklenir.

4. **500 maç döngüsü (her biri için):**  
   - `skipListener.reset()`  
   - Rastgele `seed` ile `game.reset(players, seed)`  
   - `game.run()`  
   - Maç sonunda:
     - MCTS kazandı mı: `results[0] == WIN_GAME`
     - Skip sayısı: `skipListener.getSkipCount()`

5. **Loglama:**  
   - Konsol: İlk 10 maç, her 100. maç ve son maç için `game, mctsWon, skipCount` yazılır.  
   - CSV: Tüm 500 maç `poc_results.csv` dosyasına `game,mctsWon,skipCount` formatında yazılır.  
   - Özet: Win rate (%), ortalama Skip/maç, toplam Skip, tek maçta maksimum Skip.

---

## 3. Genel Sistemin Çalışması

Aşağıdaki akış, exploit’ten ölçüme kadar tüm adımları özetler.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  1. KURAL DEĞİŞİKLİĞİ (UnoForwardModel)                                      │
│  Skip / Draw Two oynanınca → skipTurn = true                                 │
│  _afterAction içinde: nextPlayer = skipTurn ? currentPlayer : nextPlayer     │
│  Sonuç: Aynı oyuncu tekrar oynar (Extra Turn).                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  2. DESTE (UnoGameParameters)                                                 │
│  nSkipCards = 6 → Destede daha fazla Skip kartı.                             │
│  Ajanlar daha sık Skip çeker ve (MCTS için) ekstra tur fırsatı artar.        │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  3. MAÇ DÖNGÜSÜ (POCRunner)                                                   │
│  • Oyun: UNO, 2 oyuncu, yukarıdaki parametrelerle.                           │
│  • Oyuncu 0: MCTSPlayer, Oyuncu 1: RandomPlayer.                             │
│  • Her maç: reset(players, seed) → run()                                     │
│  • Listener her ACTION_TAKEN’da “Oyuncu 0 Skip oynadı mı?” diye bakar.       │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  4. LOGLAMA                                                                   │
│  • Her maç: gameId, mctsWon, skipCount → konsol (seçili) + poc_results.csv   │
│  • Özet: MCTS win rate, ortalama Skip/maç, toplam Skip, max Skip/maç.       │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Veri akışı (bir maç için):**

1. `Game.run()` → oyuncular sırayla aksiyon seçir.
2. `PlayCard` (Skip/Draw Two) oynanınca `PlayCard.execute()` → `setSkipTurn(true)`.
3. `UnoForwardModel._afterAction()` → exploit ile `nextPlayer = getCurrentPlayer()` → sıra aynı oyuncuda kalır.
4. Aynı oyuncu tekrar hamle yapar (ekstra tur).
5. Framework `ACTION_TAKEN` event’i fırlatır; `POCSkipCountListener` Oyuncu 0 + Skip ise sayacı artırır.
6. Maç biter; Runner `getPlayerResults()` ve `getSkipCount()` ile sonucu ve Skip sayısını yazar.

---

## 4. Çalıştırma ve Sonuçların Yorumlanması

**Çalıştırma:**

- IDE’den: `evaluation.POCRunner` sınıfının `main` metodunu çalıştırın.
- Komut satırı (Maven):  
  `mvn compile exec:java -Dexec.mainClass="evaluation.POCRunner"`

**Çıktılar:**

- Konsolda seçili maçlar ve en sonda özet (win rate, ortalama/toplam/max Skip).
- Proje kökünde `poc_results.csv`: Tüm maçlar için `game,mctsWon,skipCount`.

**Beklenti (açığın sömürülmesi):**

- MCTS win rate’i Random’a göre **belirgin şekilde yüksek** olmalı (ör. %70+).
- MCTS’in maç başına ortalama Skip kullanımı **anlamlı şekilde pozitif** olmalı; MCTS Skip’i “ekstra tur” için tercih ediyor olmalı.
- Bu iki bulgu birlikte, MCTS’in tasarım açığını fark edip stratejisini bu karta dayandırdığını destekler.

---

## 5. Dosya Özeti

| Dosya | Değişiklik / Rol |
|-------|-------------------|
| `games/uno/UnoForwardModel.java` | Extra Turn exploit: `skipTurn` iken sıra aynı oyuncuda. |
| `games/uno/UnoGameParameters.java` | `nSkipCards` varsayılanı 2 → 6. |
| `evaluation/POCSkipCountListener.java` | Oyuncu 0’ın Skip oynama sayısını sayar. |
| `evaluation/POCRunner.java` | 500 maç MCTS vs Random, loglama ve özet. |
| `poc_results.csv` | Runner tarafından üretilir; maç bazlı ham veri. |

Bu doküman, yapılan tüm değişiklikleri ve sistemin uçtan uca nasıl çalıştığını tek bir referansta toplar.
